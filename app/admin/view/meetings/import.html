<div class="search">
  <form class="form-inline" id="fileUploadForm">
            <label class="col-xs-4 col-sm-2 col-md-2 col-lg-1 control-label dd_input_l">选择类型</label>
            <select id="balanceType" name="huodong_id" class="form-control">
                <option value="">待选择</option>

                <option value="1">参会奖励</option>
                <option value="2">邀请奖励</option>
                <option value="3">参会奖励第二种方式</option>

            </select>

    <div class="row dd_input_group">
      <div class="form-group">
        <label class="col-xs-4 col-sm-2 col-md-2 col-lg-1 control-label dd_input_l">上传</label>
        <div class="col-xs-4 col-sm-2 col-md-2 col-lg-2">

          <input type="file" class="form-control" name="file" id="file">
        </div>
        <div class="col-xs-1 col-sm-4 col-md-6 col-lg-6 dd_ts">*</div>
      </div>
    </div>


    <input class="btn btn-flat btn-primary m_10" type="button" value="上传" id="uploadBtn">

    <div class="row">
      <div class="col-xs-12">
        <div id="importInfo" style="margin-top: 10px; font-weight: bold; line-height: 1.8em;"></div>
      </div>
    </div>

  </form>
</div>
<div class="row">
  <div class="col-xs-12">
<!--    <a href="/import2.xlsx">查看示例文件</a>-->
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <div class="box">
      <div class="box-header">
        <div class="box-body table-responsive no-padding">
          <table class="table table-bordered table-hover table-striped">
            <tbody id="body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#uploadBtn').click(function() {
      var selectedType = $('#balanceType').val();
      if (!selectedType) {
          alert('请先选择一个项目');
          return;
      }
      var loadingIndex = layer.load(1, { shade: [0.5, '#000'] }); // 显示loading，设置遮罩层

      var formData = new FormData($('#fileUploadForm')[0]);
      $.ajax({
        url: '{:url("admin/Meetings/importSubmit")}',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        dataType: 'json',
        success: function(response) {
          console.log('File uploaded successfully:', response);
          if(response.code == 200){
            layer.close(loadingIndex);
            $("#body").html('');

            var now = new Date().toLocaleString();
            var admin = response.data.admin || '管理员'; // 后台传的管理员名字

            $("#importInfo").html(
                    "共导入 <span style='color: #007bff'>" + response.data.count + "</span> 条记录<br>" +
                    "操作时间：<span style='color: #28a745'>" + now + "</span><br>" +
                    "操作人：<span style='color: #ffc107'>" + admin + "</span>"
            );

            $.each(response.data.list, function(i, val) {
              var checkedStatus = "checked='checked'";
              if (val.head) checkedStatus = '';
              var row = $("<tr><td><input type='checkbox' data-id='"+val.id+"' data-amount='"+val.amount+"' data-remark='"+val.remark+"' " + checkedStatus + "></td>" +
                      "<td>" + val.phone + "</td>" +
                      "<td>" + val.amount + "</td>" +
                      "<td>" + val.remark + "</td></tr>");
              $("#body").append(row);
            });

            $("#body").append($("<tr><td></td><td><input class='btn btn-flat btn-primary m_10' type='button' value='确认提交' id='upBalance'></td></tr>"));
          }else{
            layer.close(loadingIndex);
            alert(response.msg);
          }

        },
        error: function(xhr, status, error) {
          console.error('File upload failed:', status, error);
        }
      });
    });

    $(document).on('click', '#upBalance', function() {
      var loadingIndex = layer.load(1, { shade: [0.5, '#000'] }); // 显示loading，设置遮罩层

      var selectedType = $('#balanceType').val();
      if (!selectedType) {
          alert('请先选择一个项目');
          return;
      }

      var checkedValues = $('input[type="checkbox"]:checked').map(function() {
        return {'id': $(this).attr('data-id'), 'amount': $(this).attr('data-amount'), 'remark': $(this).attr('data-remark')};
      }).get();

      if (checkedValues.length === 0) {
        alert('请至少选择一条记录进行提交');
        return;
      }

      $.ajax({
        url:'{:url("admin/Meetings/importExec")}',
        type: 'POST',
        dataType: 'json',
        data: {'ids': checkedValues,  'huodong_id': $('#balanceType').val()},
        success: function(response) {
          console.log(response);
          if (response.code == 200) {
            layer.close(loadingIndex);
            $("#body").html('');
            alert('操作成功');
          } else {
            layer.close(loadingIndex);
            alert('操作失败: ' + response.message);
          }
        },
        error: function(e) {
          layer.close(loadingIndex);
          console.log(e);
        }
      });
    });
  });
</script>